---
- name: Discover dotfiles
  ansible.builtin.find:
    paths: "{{ role_path }}/files"
    file_type: file
    hidden: true
    patterns:
      - ".??*"  # ignore . and ..
  register: control_node_dotfiles
  tags:
    - dot_files

- name: Fail when no dotfiles found
  ansible.builtin.fail:
    msg: "No dotfiles found in {{ role_path }}/files"
  when: control_node_dotfiles.files | length == 0
  tags:
    - dot_files

- name: Copy dotfiles to control node user home
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ ansible_env.HOME | default('/root') }}/{{ item.path | basename }}"
    owner: "{{ ansible_env.USER | default('root') }}"
    group: "{{ ansible_env.USER | default('root') }}"
    mode: preserve
  loop: "{{ control_node_dotfiles.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  become: true
  tags:
    - dot_files
